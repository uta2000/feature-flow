# Compact Progress Index Implementation Plan

<!-- PROGRESS INDEX (updated by implementation skills)
Task 1: Add Progress Index format to Writing Plans Quality Context Injection — STATUS: pending
Task 2: Add Progress Index Update Protocol to Subagent-Driven Development handling — STATUS: pending
Task 3: Update post-compaction recovery to read index first — STATUS: pending
CURRENT: none
-->

> **For Claude:** After compaction, read only the PROGRESS INDEX to determine current task.
> Then read the full section for that specific task only.

**Goal:** Add a compact progress index to plan files so that post-compaction recovery reads only 30 lines instead of the entire 200+ line plan.

**Architecture:** All changes are confined to `skills/start/SKILL.md` in the feature-flow project. The start skill already has override/injection sections for both `writing-plans` (Writing Plans Quality Context Injection) and `subagent-driven-development` (Subagent-Driven Development YOLO Override + Implementer Quality Context Injection). We extend these existing mechanisms rather than modifying the superpowers plugin's cached files.

**Tech Stack:** Markdown skill files only — no TypeScript or Python.

---

### Task 1: Add Progress Index format to Writing Plans Quality Context Injection

**Files:**
- Modify: `skills/start/SKILL.md` (design-first — 1577 lines)

The "Writing Plans Quality Context Injection" section (around line 647) prepends requirements to every plan generated by `superpowers:writing-plans`. We add a new item (item 4) instructing the planner to include a Progress Index HTML comment block at the top of every generated plan, immediately after the plan title and before the existing header content.

**Step 1: Design change plan for skills/start/SKILL.md**

The "Writing Plans Quality Context Injection" section ends at approximately line 687 (before "### Using Git Worktrees YOLO Override"). Currently it has 3 numbered items. We add item 4:

Location: After item 3 (starting "**File modification complexity required...**") and its sub-bullets, before the "**Example task with quality constraints:**" block. The new item goes between the 3 numbered items and the example block.

New content to insert:

```
4. **Progress Index header required in every plan.** Every plan file must include a machine-readable Progress Index HTML comment immediately after the plan title line and before any other content. The index lists every task by number and name with STATUS: pending, and sets CURRENT: none. Example:

   ```markdown
   # [Feature Name] Implementation Plan

   <!-- PROGRESS INDEX (updated by implementation skills)
   Task 1: [name] — STATUS: pending
   Task 2: [name] — STATUS: pending
   Task 3: [name] — STATUS: pending
   CURRENT: none
   -->

   > **For Claude:** After compaction, read only the PROGRESS INDEX to determine current task.
   > Then read the full section for that specific task only.
   ```

   **Rules:**
   - Use HTML comment syntax (`<!-- ... -->`) so the index doesn't render in markdown viewers
   - Include every task from the plan (one line per task)
   - STATUS values: `pending`, `in-progress`, `done (commit [SHA])`
   - CURRENT: task number when a task is active, `none` when between tasks or at start
   - The callout block (`> **For Claude:**`) must immediately follow the closing `-->` on a new line
```

**Step 2: Edit skills/start/SKILL.md**

Add item 4 between the end of item 3 and the "**Example task with quality constraints:**" block.

**Step 3: Commit**

```bash
git add skills/start/SKILL.md
git commit -m "feat: add progress index format to writing-plans quality context injection"
```

**Acceptance Criteria:**
- [ ] `Writing Plans Quality Context Injection` section in `skills/start/SKILL.md` contains a new item 4 requiring the Progress Index header
- [ ] The Progress Index uses HTML comment syntax (`<!-- PROGRESS INDEX ... -->`)
- [ ] The format matches the spec from issue #116: task name + STATUS field + CURRENT field
- [ ] A `> **For Claude:**` callout immediately follows the index, instructing post-compaction recovery to read the index first
- [ ] Edge case: empty task lists (0 tasks) → index block still present but with `CURRENT: none` and no task lines

**Quality Constraints:**
- Instruction clarity: every rule in the new item must be unambiguous and self-contained
- Pattern: follow the style of existing items 1-3 in the same section (numbered, bold label, indented sub-bullets)
- Files modified: `skills/start/SKILL.md` (design-first — 1577 lines)
- Design-first files: `skills/start/SKILL.md` — output change plan before ANY Edit call

---

### Task 2: Add Progress Index Update Protocol to Subagent-Driven Development handling

**Files:**
- Modify: `skills/start/SKILL.md` (design-first — 1577 lines)

The `subagent-driven-development` skill orchestrates the task execution loop. After each task's reviews pass and it's marked complete in TodoWrite, the orchestrator must also update the PROGRESS INDEX in the plan file. This is encoded in a new unconditional section called "Subagent-Driven Development Context Injection" added after the "Subagent-Driven Development YOLO Override" section (around line 731).

**Step 1: Design change plan for skills/start/SKILL.md**

Location: Insert new section "### Subagent-Driven Development Context Injection" after line 730 (end of "Subagent-Driven Development YOLO Override" section) and before line 732 "### Implementer Quality Context Injection".

New content:

```
### Subagent-Driven Development Context Injection

This section applies unconditionally in all modes (YOLO, Express, Interactive). When `subagent-driven-development` is executing the task loop, maintain the Progress Index in the plan file after each task's status changes.

**Protocol (runs in the orchestrator after each task status change):**

**When starting a task (before dispatching the implementer subagent):**
1. Get the current commit SHA: `git rev-parse HEAD`
2. Edit the plan file to update the task's STATUS: `pending` → `in-progress` and set `CURRENT: Task N`
3. Use the Edit tool with old/new strings targeting the specific STATUS line for that task

Example edit (starting Task 2):
- old_string: `Task 2: [name] — STATUS: pending`
- new_string: `Task 2: [name] — STATUS: in-progress`
- old_string: `CURRENT: none` (or `CURRENT: Task 1`)
- new_string: `CURRENT: Task 2`

**When completing a task (after both spec and code quality reviews pass):**
1. Get the commit SHA of the task's final commit: `git rev-parse HEAD`
2. Edit the plan file to update the task's STATUS: `in-progress` → `done (commit [SHA])` and set `CURRENT: none` (or the next task's number if proceeding immediately)
3. Use the Edit tool with old/new strings targeting the specific STATUS line for that task

Example edit (completing Task 2 with commit abc1234):
- old_string: `Task 2: [name] — STATUS: in-progress`
- new_string: `Task 2: [name] — STATUS: done (commit abc1234)`
- old_string: `CURRENT: Task 2`
- new_string: `CURRENT: none`

**Backward compatibility:**
- If the plan file does not contain a PROGRESS INDEX block, skip all index updates silently (old plan files without the index still work normally)
- Detection: check if the plan file contains `<!-- PROGRESS INDEX` before attempting any Edit operations on the index
```

**Step 2: Edit skills/start/SKILL.md**

Insert the new section between the Subagent-Driven Development YOLO Override and Implementer Quality Context Injection sections.

**Step 3: Commit**

```bash
git add skills/start/SKILL.md
git commit -m "feat: add subagent-driven-development context injection for progress index maintenance"
```

**Acceptance Criteria:**
- [ ] A new "Subagent-Driven Development Context Injection" section exists in `skills/start/SKILL.md`
- [ ] The section says "applies unconditionally in all modes" (matching the pattern of Implementer Quality Context Injection)
- [ ] Protocol specifies Edit operations for both `pending → in-progress` (task start) and `in-progress → done (commit SHA)` (task complete) transitions
- [ ] CURRENT field is updated alongside STATUS field in both transitions
- [ ] Backward compatibility: if no `<!-- PROGRESS INDEX` block in plan file, skip silently
- [ ] Edge case: tasks with no commit yet (pending/in-progress) → SHA is only added on `done` transition, not before

**Quality Constraints:**
- Instruction clarity: Edit operation examples must be concrete and reproducible
- Pattern: follow the format of "Implementer Quality Context Injection" section (same heading level, same "applies unconditionally" preamble, numbered steps)
- Files modified: `skills/start/SKILL.md` (design-first — 1577 lines)
- Design-first files: `skills/start/SKILL.md` — output change plan before ANY Edit call

---

### Task 3: Update post-compaction recovery to read index first

**Files:**
- Modify: `skills/start/SKILL.md` (design-first — 1577 lines)

The "Handling the response" section (around line 609) currently says to "Check the todo list (via TaskList if available, or from the last printed checklist) to determine the current step." This should be extended to also support reading the plan file's PROGRESS INDEX for task-level recovery (not just lifecycle-step-level recovery).

**Step 1: Design change plan for skills/start/SKILL.md**

Location: The "Handling the response" section at line 609. Currently it reads:

```
- If the user ran `/compact` and then sends any message → the context has been compressed. Check the todo list (via `TaskList` if available, or from the last printed checklist) to determine the current step and announce: "Resuming lifecycle. Last completed step: [N]. Next: [N+1] — [name]."
```

We extend this bullet to add plan-file index recovery for the implementation step:

```
- If the user ran `/compact` and then sends any message → the context has been compressed. Check the todo list (via `TaskList` if available, or from the last printed checklist) to determine the current lifecycle step.
  - **If the current lifecycle step is "Implement":** Read only lines 1-30 of the plan file (the PROGRESS INDEX block) to determine which task is current. Parse the `CURRENT: Task N` field. Then read only the full Task N section from the plan file for implementation details. Announce: "Resuming implementation. Reading progress index... CURRENT: Task N. Loading Task N details."
  - **If no PROGRESS INDEX found in lines 1-30:** Fall back to reading the full plan file to determine which task to resume.
  - Announce: "Resuming lifecycle. Last completed step: [N]. Next: [N+1] — [name]."
```

**Step 2: Edit skills/start/SKILL.md**

Replace the existing `/compact` handling bullet with the extended version that includes the plan-file index check.

**Step 3: Commit**

```bash
git add skills/start/SKILL.md
git commit -m "feat: update post-compaction recovery to read progress index first"
```

**Acceptance Criteria:**
- [ ] The "Handling the response" section in `skills/start/SKILL.md` instructs reading only lines 1-30 of the plan file after `/compact` during the "Implement" lifecycle step
- [ ] The instruction specifies parsing `CURRENT: Task N` from the PROGRESS INDEX
- [ ] The instruction specifies reading only the full Task N section after identifying current task from index
- [ ] Fallback: if no PROGRESS INDEX found in first 30 lines, fall back to reading full plan file
- [ ] Edge case: if `CURRENT: none` (between tasks), treat as "start from the first pending task"

**Quality Constraints:**
- Instruction clarity: the recovery procedure must be deterministic — no ambiguity about what to read when
- Pattern: follow the existing bullet format in the "Handling the response" section (indented sub-bullets for conditions)
- Files modified: `skills/start/SKILL.md` (design-first — 1577 lines)
- Design-first files: `skills/start/SKILL.md` — output change plan before ANY Edit call
